name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - "master"
      - "dev"
    paths:
      - "**.hpp"
      - "**.cpp"
      - "**.h"
      - "**.c"
      - "**CMakeLists.txt"
      - ".github/workflows/build.yml"
  pull_request:
    branches:
      - "*"
      - "*/*"
      - "**"
    paths:
      - "**.hpp"
      - "**.cpp"
      - "**.h"
      - "**.c"
      - "**CMakeLists.txt"
      - ".github/workflows/build.yml"

jobs:
  build-windows:
    runs-on: [self-hosted, Windows]

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Generate Version String
        id: version
        run: echo "::set-output name=tag::$(git describe --always --tags)"

      - name: Show Version String
        run: |
          echo 'Built version: ${{steps.version.outputs.tag}}'

      - name: Setup Python
        uses: actions/setup-python@v2

      - name: Install CMake
        uses: lukka/get-cmake@v3.19.0

      - name: Install latest conan
        run: |
          python -m pip install --upgrade pip
          pip install conan
      - name: Generate build files
        run: mkdir build && cd build && cmake .. -G "Visual Studio 16 2019" -A Win32 -T "ClangCL"

      # - name: Build
      #   run: |
      #     cd build
      #     cmake --build . --config Debug

      - name: Upload S3
        uses: jakejarvis/s3-sync-action@master
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_S3_ENDPOINT: https://assets.open.mp
          AWS_S3_BUCKET: ${{ secrets.AWS_BUCKET }}
          # SOURCE_DIR: "build/Output"
          SOURCE_DIR: "build"
          DEST_DIR: ${{steps.version.outputs.tag}}

  build-linux:
    runs-on: [self-hosted, Linux]

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Generate Version String
        id: version
        run: echo "::set-output name=tag::$(git describe --always --tags)"

      - name: Show Version String
        run: |
          echo 'Built version: ${{steps.version.outputs.tag}}'

      - name: Setup Python
        uses: actions/setup-python@v2

      - name: Install CMake
        uses: lukka/get-cmake@v3.19.0

      - name: Install gcc/g++-multilib for linux & set clang
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update -y
          sudo apt install -y gcc-multilib g++-multilib clang
          echo "CC=/usr/bin/clang" >> $GITHUB_ENV
          echo "CXX=/usr/bin/clang++" >> $GITHUB_ENV
      - name: Install latest conan
        run: |
          python -m pip install --upgrade pip
          pip install conan
      - name: Generate build files
        run: mkdir build && cd build && cmake .. -G Ninja -DCMAKE_CXX_FLAGS=-m32 -DCMAKE_C_FLAGS=-m32 -DCMAKE_BUILD_TYPE=Release

      # - name: Build
      #   run: |
      #     cd build
      #     cmake --build . --config Debug

      - name: Upload S3
        uses: jakejarvis/s3-sync-action@master
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_S3_ENDPOINT: https://assets.open.mp
          AWS_S3_BUCKET: ${{ secrets.AWS_BUCKET }}
          # SOURCE_DIR: "build/Output/Debug/Server"
          SOURCE_DIR: "build"
          DEST_DIR: ${{steps.version.outputs.tag}}
